var hmac=function(alg,key,data){var mac=new KJUR.crypto.Mac({alg:"hmac"+alg,pass:key});return mac.updateString(data),hex2b64(mac.doFinal())},constTimeEqual=function(s1,s2){if(s1.length!==s2.length)return!1;var i,c=0;for(i=0;i<s1.length;i+=1)c|=s1.charCodeAt(i)^s2.charCodeAt(i);return 0===c};"undefined"!=typeof KJUR&&KJUR||(KJUR={}),"undefined"!=typeof KJUR.jws&&KJUR.jws||(KJUR.jws={}),KJUR.jws.JWS=function(){function _getSignatureInputByString(sHead,sPayload){return utf8tob64u(sHead)+"."+utf8tob64u(sPayload)}function _jws_getHashAlgFromParsedHead(head){var sigAlg=head.alg,hashAlg="";if(!supportedAlgos[sigAlg])throw"JWS signature algorithm not supported: "+sigAlg;return"256"==sigAlg.substr(2)&&(hashAlg="sha256"),"512"==sigAlg.substr(2)&&(hashAlg="sha512"),hashAlg}function _jws_getHashAlgFromHead(sHead){return _jws_getHashAlgFromParsedHead(jsonParse(sHead))}function _jws_generateSignatureValueBySI_NED(sHead,sPayload,sSI,hN,hE,hD){var rsa=new RSAKey;rsa.setPrivate(hN,hE,hD);var hashAlg=_jws_getHashAlgFromHead(sHead),sigValue=rsa.signString(sSI,hashAlg);return sigValue}function _jws_generateSignatureValueBySI_Key(headP,sPayload,sSI,key){var alg=headP.alg;if("none"===alg)return"";var hashAlg=_jws_getHashAlgFromParsedHead(headP);alg=alg.substr(0,2);var isPSS="PS"===alg;return key.hashAndSign?b64tob64u(key.hashAndSign(hashAlg,sSI,"utf8","base64",isPSS)):isPSS?hextob64u(key.signStringPSS(sSI,hashAlg)):"HS"===alg?b64tob64u(hmac(hashAlg,key,sSI)):hextob64u(key.signString(sSI,hashAlg))}function _jws_generateSignatureValueBySI_PemPrvKey(sHead,sPayload,sSI,sPemPrvKey){var rsa=new RSAKey;rsa.readPrivateKeyFromPEMString(sPemPrvKey);var hashAlg=_jws_getHashAlgFromHead(sHead),sigValue=rsa.signString(sSI,hashAlg);return sigValue}this.isSafeJSONString=function(s,h,p){var o=null;try{return o=jsonParse(s),"object"!=typeof o?0:o.constructor===Array?0:(h&&(h[p]=o),1)}catch(ex){return 0}},this.readSafeJSONString=function(s){var o=null;try{return o=jsonParse(s),"object"!=typeof o?null:o.constructor===Array?null:o}catch(ex){return null}},this.getEncodedSignatureValueFromJWS=function(sJWS){if(null==sJWS.match(/^[^.]+\.[^.]+\.([^.]+)$/))throw"JWS signature is not a form of 'Head.Payload.SigValue'.";return RegExp.$1},this.parseJWS=function(sJWS,sigValNotNeeded){if(void 0===this.parsedJWS||!sigValNotNeeded&&void 0===this.parsedJWS.sigvalH){if(null==sJWS.match(/^([^.]+)\.([^.]+)\.([^.]+)$/))throw"JWS signature is not a form of 'Head.Payload.SigValue'.";var b6Head=RegExp.$1,b6Payload=RegExp.$2,b6SigVal=RegExp.$3,sSI=b6Head+"."+b6Payload;if(this.parsedJWS={},this.parsedJWS.headB64U=b6Head,this.parsedJWS.payloadB64U=b6Payload,this.parsedJWS.sigvalB64U=b6SigVal,this.parsedJWS.si=sSI,!sigValNotNeeded){var hSigVal=b64utohex(b6SigVal),biSigVal=parseBigInt(hSigVal,16);this.parsedJWS.sigvalH=hSigVal,this.parsedJWS.sigvalBI=biSigVal}var sHead=b64utoutf8(b6Head),sPayload=b64utoutf8(b6Payload);if(this.parsedJWS.headS=sHead,this.parsedJWS.payloadS=sPayload,!this.isSafeJSONString(sHead,this.parsedJWS,"headP"))throw"malformed JSON string for JWS Head: "+sHead}},this.verifyJWSByNE=function(sJWS,hN,hE){return this.parseJWS(sJWS),_rsasign_verifySignatureWithArgs(this.parsedJWS.si,this.parsedJWS.sigvalBI,hN,hE)},this.verifyJWSByKey=function(sJWS,key,allowedAlgs){function isAllowed(a){return Array.isArray(allowedAlgs)?allowedAlgs.indexOf(a)>=0:void 0!==allowedAlgs[a]}this.parseJWS(sJWS,!key||!key.verifyString);var headP=this.parsedJWS.headP,alg=headP.alg;if(void 0===alg)throw new Error("alg not present");if(allowedAlgs=allowedAlgs||[],!isAllowed(alg))throw new Error("algorithm not allowed: "+alg);if("none"===alg)return!0;if(!key){if(!isAllowed("none"))throw new Error("no key but none alg not allowed");return!0}var hashAlg=_jws_getHashAlgFromParsedHead(headP);alg=alg.substr(0,2);var r,isPSS="PS"===alg;if(r=key.hashAndVerify?key.hashAndVerify(hashAlg,new Buffer(this.parsedJWS.si,"utf8"),new Buffer(b64utob64(this.parsedJWS.sigvalB64U),"base64"),null,isPSS):isPSS?key.verifyStringPSS(this.parsedJWS.si,this.parsedJWS.sigvalH,hashAlg):"HS"===alg?constTimeEqual(hmac(hashAlg,key,this.parsedJWS.si),b64utob64(this.parsedJWS.sigvalB64U)):key.verifyString(this.parsedJWS.si,this.parsedJWS.sigvalH),!r)throw new Error("failed to verify");return r},this.verifyJWSByPemX509Cert=function(sJWS,sPemX509Cert){this.parseJWS(sJWS);var x509=new X509;return x509.readCertPEM(sPemX509Cert),x509.subjectPublicKeyRSA.verifyString(this.parsedJWS.si,this.parsedJWS.sigvalH)};var supportedAlgos={RS256:!0,RS512:!0,PS256:!0,PS512:!0,HS256:!0,HS512:!0};this.generateJWSByNED=function(sHead,sPayload,hN,hE,hD){if(!this.isSafeJSONString(sHead))throw"JWS Head is not safe JSON string: "+sHead;var sSI=_getSignatureInputByString(sHead,sPayload),hSigValue=_jws_generateSignatureValueBySI_NED(sHead,sPayload,sSI,hN,hE,hD),b64SigValue=hextob64u(hSigValue);return this.parsedJWS={},this.parsedJWS.headB64U=sSI.split(".")[0],this.parsedJWS.payloadB64U=sSI.split(".")[1],this.parsedJWS.sigvalB64U=b64SigValue,sSI+"."+b64SigValue},this.generateJWSByKey=function(sHead,sPayload,key){var obj={};if(!this.isSafeJSONString(sHead,obj,"headP"))throw"JWS Head is not safe JSON string: "+sHead;var sSI=_getSignatureInputByString(sHead,sPayload),b64SigValue=_jws_generateSignatureValueBySI_Key(obj.headP,sPayload,sSI,key);return this.parsedJWS={},this.parsedJWS.headB64U=sSI.split(".")[0],this.parsedJWS.payloadB64U=sSI.split(".")[1],this.parsedJWS.sigvalB64U=b64SigValue,sSI+"."+b64SigValue},this.generateJWSByP1PrvKey=function(sHead,sPayload,sPemPrvKey){if(!this.isSafeJSONString(sHead))throw"JWS Head is not safe JSON string: "+sHead;var sSI=_getSignatureInputByString(sHead,sPayload),hSigValue=_jws_generateSignatureValueBySI_PemPrvKey(sHead,sPayload,sSI,sPemPrvKey),b64SigValue=hextob64u(hSigValue);return this.parsedJWS={},this.parsedJWS.headB64U=sSI.split(".")[0],this.parsedJWS.payloadB64U=sSI.split(".")[1],this.parsedJWS.sigvalB64U=b64SigValue,sSI+"."+b64SigValue}};