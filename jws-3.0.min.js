var hmac=function(alg,key,data){var mac=new KJUR.crypto.Mac({alg:"hmac"+alg,pass:key});return mac.updateString(data),hex2b64(mac.doFinal())},constTimeEqual=function(s1,s2){"use strict";if(s1.length!==s2.length)return!1;var i,c=0;for(i=0;i<s1.length;i+=1)c|=s1.charCodeAt(i)^s2.charCodeAt(i);return 0===c};"undefined"!=typeof KJUR&&KJUR||(KJUR={}),"undefined"!=typeof KJUR.jws&&KJUR.jws||(KJUR.jws={}),KJUR.jws.JWS=function(){function _getSignatureInputByString(sHead,sPayload){return utf8tob64u(sHead)+"."+utf8tob64u(sPayload)}function _jws_getHashAlgFromParsedHead(head){var sigAlg=head.alg,hashAlg="";if(!supportedAlgos[sigAlg])throw"JWS signature algorithm not supported: "+sigAlg;return"256"==sigAlg.substr(2)&&(hashAlg="sha256"),"512"==sigAlg.substr(2)&&(hashAlg="sha512"),hashAlg}function _jws_getHashAlgFromHead(sHead){return _jws_getHashAlgFromParsedHead(jsonParse(sHead))}function _jws_generateSignatureValueBySI_NED(sHead,sPayload,sSI,hN,hE,hD){var rsa=new RSAKey;rsa.setPrivate(hN,hE,hD);var hashAlg=_jws_getHashAlgFromHead(sHead),sigValue=rsa.signString(sSI,hashAlg);return sigValue}function _jws_generateSignatureValueBySI_Key(headP,sPayload,sSI,key){var alg=headP.alg;if("none"===alg)return"";var hashAlg=_jws_getHashAlgFromParsedHead(headP);alg=alg.substr(0,2);var isPSS="PS"===alg;return key.hashAndSign?b64tob64u(key.hashAndSign(hashAlg,sSI,"utf8","base64",isPSS)):isPSS?hextob64u(key.signStringPSS(sSI,hashAlg)):"HS"===alg?b64tob64u(hmac(hashAlg,key,sSI)):hextob64u(key.signString(sSI,hashAlg))}function _jws_generateSignatureValueBySI_PemPrvKey(sHead,sPayload,sSI,sPemPrvKey){var rsa=new RSAKey;rsa.readPrivateKeyFromPEMString(sPemPrvKey);var hashAlg=_jws_getHashAlgFromHead(sHead),sigValue=rsa.signString(sSI,hashAlg);return sigValue}this.parseJWS=function(sJWS,sigValNotNeeded){if(void 0===this.parsedJWS||!sigValNotNeeded&&void 0===this.parsedJWS.sigvalH){if(null==sJWS.match(/^([^.]+)\.([^.]+)\.([^.]+)$/))throw"JWS signature is not a form of 'Head.Payload.SigValue'.";var b6Head=RegExp.$1,b6Payload=RegExp.$2,b6SigVal=RegExp.$3,sSI=b6Head+"."+b6Payload;if(this.parsedJWS={},this.parsedJWS.headB64U=b6Head,this.parsedJWS.payloadB64U=b6Payload,this.parsedJWS.sigvalB64U=b6SigVal,this.parsedJWS.si=sSI,!sigValNotNeeded){var hSigVal=b64utohex(b6SigVal),biSigVal=parseBigInt(hSigVal,16);this.parsedJWS.sigvalH=hSigVal,this.parsedJWS.sigvalBI=biSigVal}var sHead=b64utoutf8(b6Head),sPayload=b64utoutf8(b6Payload);if(this.parsedJWS.headS=sHead,this.parsedJWS.payloadS=sPayload,!this.isSafeJSONString(sHead,this.parsedJWS,"headP"))throw"malformed JSON string for JWS Head: "+sHead}},this.verifyJWSByNE=function(sJWS,hN,hE){return this.parseJWS(sJWS),_rsasign_verifySignatureWithArgs(this.parsedJWS.si,this.parsedJWS.sigvalBI,hN,hE)},this.verifyJWSByKey=function(sJWS,key,allowedAlgs){function isAllowed(a){return Array.isArray(allowedAlgs)?allowedAlgs.indexOf(a)>=0:void 0!==allowedAlgs[a]}this.parseJWS(sJWS,!key||!key.verifyString);var headP=this.parsedJWS.headP,alg=headP.alg;if(void 0===alg)throw new Error("alg not present");if(allowedAlgs=allowedAlgs||[],!isAllowed(alg))throw new Error("algorithm not allowed: "+alg);if("none"===alg)return!0;if(!key){if(!isAllowed("none"))throw new Error("no key but none alg not allowed");return!0}var hashAlg=_jws_getHashAlgFromParsedHead(headP);alg=alg.substr(0,2);var r,isPSS="PS"===alg;if(r=key.hashAndVerify?key.hashAndVerify(hashAlg,new Buffer(this.parsedJWS.si,"utf8"),new Buffer(b64utob64(this.parsedJWS.sigvalB64U),"base64"),null,isPSS):isPSS?key.verifyStringPSS(this.parsedJWS.si,this.parsedJWS.sigvalH,hashAlg):"HS"===alg?constTimeEqual(hmac(hashAlg,key,this.parsedJWS.si),b64utob64(this.parsedJWS.sigvalB64U)):key.verifyString(this.parsedJWS.si,this.parsedJWS.sigvalH),!r)throw new Error("failed to verify");return r},this.verifyJWSByPemX509Cert=function(sJWS,sPemX509Cert){this.parseJWS(sJWS);var x509=new X509;return x509.readCertPEM(sPemX509Cert),x509.subjectPublicKeyRSA.verifyString(this.parsedJWS.si,this.parsedJWS.sigvalH)};var supportedAlgos={RS256:!0,RS512:!0,PS256:!0,PS512:!0,HS256:!0,HS512:!0};this.generateJWSByNED=function(sHead,sPayload,hN,hE,hD){if(!this.isSafeJSONString(sHead))throw"JWS Head is not safe JSON string: "+sHead;var sSI=_getSignatureInputByString(sHead,sPayload),hSigValue=_jws_generateSignatureValueBySI_NED(sHead,sPayload,sSI,hN,hE,hD),b64SigValue=hextob64u(hSigValue);return this.parsedJWS={},this.parsedJWS.headB64U=sSI.split(".")[0],this.parsedJWS.payloadB64U=sSI.split(".")[1],this.parsedJWS.sigvalB64U=b64SigValue,sSI+"."+b64SigValue},this.generateJWSByKey=function(sHead,sPayload,key){var obj={};if(!this.isSafeJSONString(sHead,obj,"headP"))throw"JWS Head is not safe JSON string: "+sHead;var sSI=_getSignatureInputByString(sHead,sPayload),b64SigValue=_jws_generateSignatureValueBySI_Key(obj.headP,sPayload,sSI,key);return this.parsedJWS={},this.parsedJWS.headB64U=sSI.split(".")[0],this.parsedJWS.payloadB64U=sSI.split(".")[1],this.parsedJWS.sigvalB64U=b64SigValue,sSI+"."+b64SigValue},this.generateJWSByP1PrvKey=function(sHead,sPayload,sPemPrvKey){if(!this.isSafeJSONString(sHead))throw"JWS Head is not safe JSON string: "+sHead;var sSI=_getSignatureInputByString(sHead,sPayload),hSigValue=_jws_generateSignatureValueBySI_PemPrvKey(sHead,sPayload,sSI,sPemPrvKey),b64SigValue=hextob64u(hSigValue);return this.parsedJWS={},this.parsedJWS.headB64U=sSI.split(".")[0],this.parsedJWS.payloadB64U=sSI.split(".")[1],this.parsedJWS.sigvalB64U=b64SigValue,sSI+"."+b64SigValue}},KJUR.jws.JWS.sign=function(alg,sHeader,sPayload,key,pass){var ns1=KJUR.jws.JWS;if(!ns1.isSafeJSONString(sHeader))throw"JWS Head is not safe JSON string: "+sHead;var pHeader=ns1.readSafeJSONString(sHeader);""!=alg&&null!=alg||void 0===pHeader.alg||(alg=pHeader.alg),""!=alg&&null!=alg&&void 0===pHeader.alg&&(pHeader.alg=alg,sHeader=JSON.stringify(pHeader));var sigAlg=null;if(void 0===ns1.jwsalg2sigalg[alg])throw"unsupported alg name: "+alg;sigAlg=ns1.jwsalg2sigalg[alg];var uHeader=utf8tob64u(sHeader),uPayload=utf8tob64u(sPayload),uSignatureInput=uHeader+"."+uPayload,hSig="";if("Hmac"==sigAlg.substr(0,4)){if(void 0===key)throw"hexadecimal key shall be specified for HMAC";var mac=new KJUR.crypto.Mac({alg:sigAlg,pass:hextorstr(key)});mac.updateString(uSignatureInput),hSig=mac.doFinal()}else if(-1!=sigAlg.indexOf("withECDSA")){var sig=new KJUR.crypto.Signature({alg:sigAlg});sig.init(key,pass),sig.updateString(uSignatureInput),hASN1Sig=sig.sign(),hSig=KJUR.crypto.ECDSA.asn1SigToConcatSig(hASN1Sig)}else if("none"!=sigAlg){var sig=new KJUR.crypto.Signature({alg:sigAlg});sig.init(key,pass),sig.updateString(uSignatureInput),hSig=sig.sign()}var uSig=hextob64u(hSig);return uSignatureInput+"."+uSig},KJUR.jws.JWS.verify=function(sJWS,key,allowedAlgs){function isAllowed(a){return Array.isArray(allowedAlgs)?allowedAlgs.indexOf(a)>=0:void 0!==allowedAlgs[a]}var jws=KJUR.jws.JWS,a=sJWS.split("."),uHeader=a[0],uPayload=a[1],uSignatureInput=uHeader+"."+uPayload,hSig=b64utohex(a[2]),pHeader=jws.readSafeJSONString(b64utoutf8(a[0])),alg=null;if(void 0===pHeader.alg)throw"algorithm not specified in header";if(alg=pHeader.alg,!isAllowed(alg))throw new Error("algorithm not allowed: "+alg);if("none"===alg)return!0;if(!key){if(!isAllowed("none"))throw new Error("no key but none alg not allowed");return!0}var sigAlg=null;if(void 0===jws.jwsalg2sigalg[pHeader.alg])throw"unsupported alg name: "+alg;sigAlg=jws.jwsalg2sigalg[alg];var sig;if("Hmac"==sigAlg.substr(0,4)){if(void 0===key)throw"hexadecimal key shall be specified for HMAC";var mac=new KJUR.crypto.Mac({alg:sigAlg,pass:hextorstr(key)});return mac.updateString(uSignatureInput),hSig2=mac.doFinal(),hSig==hSig2}if(-1!=sigAlg.indexOf("withECDSA")){var hASN1Sig=null;try{hASN1Sig=KJUR.crypto.ECDSA.concatSigToASN1Sig(hSig)}catch(ex){return!1}return sig=new KJUR.crypto.Signature({alg:sigAlg}),sig.init(key),sig.updateString(uSignatureInput),sig.verify(hASN1Sig)}return sig=new KJUR.crypto.Signature({alg:sigAlg}),sig.init(key),sig.updateString(uSignatureInput),sig.verify(hSig)},KJUR.jws.JWS.jwsalg2sigalg={HS256:"HmacSHA256",HS512:"HmacSHA512",RS256:"SHA256withRSA",RS384:"SHA384withRSA",RS512:"SHA512withRSA",ES256:"SHA256withECDSA",ES384:"SHA384withECDSA",PS256:"SHA256withRSAandMGF1",PS384:"SHA384withRSAandMGF1",PS512:"SHA512withRSAandMGF1",none:"none"},KJUR.jws.JWS.isSafeJSONString=function(s,h,p){var o=null;try{return o=jsonParse(s),"object"!=typeof o?0:o.constructor===Array?0:(h&&(h[p]=o),1)}catch(ex){return 0}},KJUR.jws.JWS.readSafeJSONString=function(s){var o=null;try{return o=jsonParse(s),"object"!=typeof o?null:o.constructor===Array?null:o}catch(ex){return null}},KJUR.jws.JWS.getEncodedSignatureValueFromJWS=function(sJWS){if(null==sJWS.match(/^[^.]+\.[^.]+\.([^.]+)$/))throw"JWS signature is not a form of 'Head.Payload.SigValue'.";return RegExp.$1},KJUR.jws.IntDate=function(){},KJUR.jws.IntDate.get=function(s){if("now"==s)return KJUR.jws.IntDate.getNow();if("now + 1hour"==s)return KJUR.jws.IntDate.getNow()+3600;if("now + 1day"==s)return KJUR.jws.IntDate.getNow()+86400;if("now + 1month"==s)return KJUR.jws.IntDate.getNow()+2592e3;if("now + 1year"==s)return KJUR.jws.IntDate.getNow()+31536e3;if(s.match(/Z$/))return KJUR.jws.IntDate.getZulu(s);if(s.match(/^[0-9]+$/))return parseInt(s);throw"unsupported format: "+s},KJUR.jws.IntDate.getZulu=function(s){if(a=s.match(/(\d{4})(\d\d)(\d\d)(\d\d)(\d\d)(\d\d)Z/)){var year=parseInt(RegExp.$1),month=parseInt(RegExp.$2)-1,day=parseInt(RegExp.$3),hour=parseInt(RegExp.$4),min=parseInt(RegExp.$5),sec=parseInt(RegExp.$6),d=new Date(Date.UTC(year,month,day,hour,min,sec));return~~(d/1e3)}throw"unsupported format: "+s},KJUR.jws.IntDate.getNow=function(){var d=~~(new Date/1e3);return d},KJUR.jws.IntDate.intDate2UTCString=function(intDate){var d=new Date(1e3*intDate);return d.toUTCString()},KJUR.jws.IntDate.intDate2Zulu=function(intDate){var d=new Date(1e3*intDate),year=("0000"+d.getUTCFullYear()).slice(-4),mon=("00"+(d.getUTCMonth()+1)).slice(-2),day=("00"+d.getUTCDate()).slice(-2),hour=("00"+d.getUTCHours()).slice(-2),min=("00"+d.getUTCMinutes()).slice(-2),sec=("00"+d.getUTCSeconds()).slice(-2);return year+mon+day+hour+min+sec+"Z"};